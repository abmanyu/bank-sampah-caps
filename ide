#include "HX711.h"
#include <Servo.h>
#include <MFRC522.h>
#include <SPI.h>
#include <Nextion.h>
#include <WiFi.h>
#include <HTTPClient.h>
#include <WiFiClientSecure.h>
#include <SMTPClient.h>
#include "ArduinoJson.h"

// Pin definisi
#define SS_PIN 21
#define RST_PIN 22
#define TRIG_PIN_A 12
#define ECHO_PIN_A 13
#define TRIG_PIN_B 23
#define ECHO_PIN_B 24
#define TRIG_PIN_C 25
#define ECHO_PIN_C 26
#define TRIG_PIN_D 27
#define ECHO_PIN_D 28
#define SERVO_PIN_A 14
#define SERVO_PIN_B 15
#define SERVO_PIN_C 16
#define SERVO_PIN_D 17

// Membuat objek untuk masing-masing komponen
HX711 scaleA, scaleB, scaleC, scaleD;
Servo servoA, servoB, servoC, servoD;
MFRC522 rfid(SS_PIN, RST_PIN);
NexPage pageLogin = NexPage(0, 0, "login");
NexPage pageHome = NexPage(1, 0, "home");
NexPage pageInfoSaldo = NexPage(2, 0, "info_saldo");
NexPage pageTarikTunai = NexPage(3, 0, "tarik_tunai");
NexPage pageMutasiRekening = NexPage(4, 0, "mutasi_rekening");
NexPage pageSelectType = NexPage(5, 0, "select_type"); // Pilihan jenis sampah
NexPage pageSelectSubtype = NexPage(6, 0, "select_subtype"); // Pilihan subjenis sampah
NexPage pageInfoSetoran = NexPage(7, 0, "info_setoran");
NexPage pageSuccess = NexPage(8, 0, "success");

// Tombol di Laman Home
NexButton btnInfoSaldo = NexButton(1, 1, "info_saldo");
NexButton btnTarikTunai = NexButton(1, 2, "tarik_tunai");
NexButton btnMutasiRekening = NexButton(1, 3, "mutasi_rekening");
NexButton btnSetorSampah = NexButton(1, 4, "setor_sampah");

NexText txtSaldo = NexText(2, 1, "txt_saldo");
NexText txtMutasi = NexText(4, 1, "txt_mutasi");
NexButton btnKirimTarik = NexButton(3, 1, "kirim_tarik");

NexText txtInputTarik = NexText(3, 2, "input_tarik");

// Tombol pada laman setoran
NexButton btnPlastik = NexButton(5, 1, "plastik");
NexButton btnKertas = NexButton(5, 2, "kertas");
NexButton btnBesi = NexButton(5, 3, "besi");
NexButton btnKaca = NexButton(5, 4, "kaca");

// Tombol untuk subjenis sampah di laman select_subtype
NexButton btnSubtype1 = NexButton(6, 1, "subtype1");
NexButton btnSubtype2 = NexButton(6, 2, "subtype2");
NexButton btnSubtype3 = NexButton(6, 3, "subtype3");
NexButton btnSubtype4 = NexButton(6, 4, "subtype4");
NexButton btnSubtype5 = NexButton(6, 5, "subtype5");

// Label untuk informasi setoran
NexText txtItem = NexText(7, 1, "item");
NexText txtWeight = NexText(7, 2, "weight");
NexText txtTotal = NexText(7, 3, "total");

// Daftar kartu RFID yang diizinkan dan saldo masing-masing
struct Card {
  String id;
  String ownerName;
  float saldo;
};

Card allowedCards[] = {
  {"1234567890AB", "Alice", 430000},
  {"0987654321CD", "Bob", 200000}
};

String currentOwner = "";
float currentSaldo = 0;
bool accessGranted = false;

// Variabel penyimpanan data setoran
float previousWeight = 0;
float totalWeight = 0;
float pricePerKg = 0;
String selectedSubtype = "";

// Harga per kg untuk tiap subjenis sampah
struct Subtype {
  String name;
  float pricePerKg;
};

Subtype plastikSubtypes[] = {
  {"Gelas Plastik", 3000},
  {"Botol Plastik Bening", 3500},
  {"Botol Plastik Warna", 3200},
  {"Plastik Kemasan", 2500}
};

Subtype kertasSubtypes[] = {
  {"Arsip", 2000},
  {"Tetra Pack", 1800},
  {"Koran", 1500},
  {"Dus", 2200}
};

Subtype besiSubtypes[] = {
  {"Seng", 5000},
  {"Besi", 4500},
  {"Aluminium", 8000},
  {"Tembaga", 7000},
  {"Per Kasur", 6000}
};

Subtype kacaSubtypes[] = {
  {"Beling", 1000},
  {"Botol Intisari", 1200},
  {"Botol Sirup", 1100},
  {"Botol Kecap", 1300}
};

// Fungsi Nextion HMI
NexTouch *nex_listen_list[] = {
  &btnInfoSaldo,
  &btnTarikTunai,
  &btnMutasiRekening,
  &btnSetorSampah,
  &btnKirimTarik,

  &btnPlastik, &btnKertas, &btnBesi, &btnKaca,
  &btnSubtype1, &btnSubtype2, &btnSubtype3, &btnSubtype4, btnSubtype5,
  NULL
};

// Fungsi untuk menginisialisasi komponen
void setup() {
  Serial.begin(115200);

  // Inisialisasi WiFi
  WiFi.begin("SSID", "password");
  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.println("Connecting to WiFi...");
  }
  Serial.println("Connected to WiFi");

  // Inisialisasi RFID
  SPI.begin();
  rfid.PCD_Init();

  // Inisialisasi Servo dan Load Cell
  servoA.attach(SERVO_PIN_A);
  servoB.attach(SERVO_PIN_B);
  servoC.attach(SERVO_PIN_C);
  servoD.attach(SERVO_PIN_D);

  servoA.write(90); // Mulai dari posisi tertutup
  servoB.write(90); // Mulai dari posisi tertutup
  servoC.write(90); // Mulai dari posisi tertutup
  servoD.write(90); // Mulai dari posisi tertutup

  scaleA.begin(LOADCELL_DOUT_PIN_A, LOADCELL_SCK_PIN_A);
  scaleB.begin(LOADCELL_DOUT_PIN_A, LOADCELL_SCK_PIN_A);
  scaleC.begin(LOADCELL_DOUT_PIN_A, LOADCELL_SCK_PIN_A);
  scaleD.begin(LOADCELL_DOUT_PIN_A, LOADCELL_SCK_PIN_A);

  scaleA.set_scale(2280.f); // Sesuaikan kalibrasi
  scaleB.set_scale(2280.f);
  scaleC.set_scale(2280.f);
  scaleD.set_scale(2280.f);

  scaleA.tare();
  scaleB.tare();
  scaleC.tare();
  scaleD.tare();

  // Inisialisasi Sensor Ultrasonik
  pinMode(TRIG_PIN_A, OUTPUT);
  pinMode(ECHO_PIN_A, INPUT);
  pinMode(TRIG_PIN_B, OUTPUT);
  pinMode(ECHO_PIN_B, INPUT);
  pinMode(TRIG_PIN_C, OUTPUT);
  pinMode(ECHO_PIN_C, INPUT);
  pinMode(TRIG_PIN_D, OUTPUT);
  pinMode(ECHO_PIN_D, INPUT);

  // Inisialisasi Nextion
  nexInit();

  // Tampilkan halaman login awal
  pageLogin.show();
}

void loop() {
  nexLoop(nex_listen_list);

  // Cek RFID untuk login
  if (!accessGranted) {
    if (checkRFID()) {
      accessGranted = true;
      pageHome.show();
    }
  }
}

// Fungsi untuk cek kartu RFID
bool checkRFID() {
  if (!rfid.PICC_IsNewCardPresent()) return false;
  if (!rfid.PICC_ReadCardSerial()) return false;

  String cardID = "";
  for (byte i = 0; i < rfid.uid.size; i++) {
    cardID += String(rfid.uid.uidByte[i], HEX);
  }
  cardID.toUpperCase();

  Serial.print("Kartu ditemukan dengan ID: ");
  Serial.println(cardID);

  for (Card &allowedCard : allowedCards) {
    if (cardID == allowedCard.id) {
      currentOwner = allowedCard.ownerName;
      currentSaldo = allowedCard.saldo;
      Serial.print("Akses diberikan kepada: ");
      Serial.println(currentOwner);
      return true;
    }
  }

  return false;
}

// Fungsi untuk mengatur tombol subjenis sampah
void selectSubtypes(Subtype subtypes[], int count) {
  btnSubtype1.setText(subtypes[0].name.c_str());
  btnSubtype2.setText(subtypes[1].name.c_str());
  btnSubtype3.setText(subtypes[2].name.c_str());
  btnSubtype4.setText(subtypes[3].name.c_str());

  if (count == 5) {
    btnSubtype5.setText(subtypes[4].name.c_str());
    btnSubtype5.show();  // Tampilkan tombol ke-5 jika ada
  } else {
    btnSubtype5.hide();  // Sembunyikan jika tidak ada subjenis ke-5
  }

  pageSelectSubtype.show();
}

// Fungsi untuk memproses subjenis sampah yang dipilih
void processSubtype(String name, float price, void (*processStorageFunc)()) {
  selectedSubtype = name;
  pricePerKg = price;
  processStorageFunc();  // Jalankan fungsi proses storage yang sesuai
}

// Fungsi yang dipanggil ketika salah satu subjenis dari Plastik dipilih
void subtype1(void *ptr) {
  processSubtype(btnSubtype1.getText(), plastikSubtypes[0].pricePerKg, processStorageA);
}

void subtype2(void *ptr) {
  processSubtype(btnSubtype2.getText(), plastikSubtypes[1].pricePerKg, processStorageA);
}

void subtype3(void *ptr) {
  processSubtype(btnSubtype3.getText(), plastikSubtypes[2].pricePerKg, processStorageA);
}

void subtype4(void *ptr) {
  processSubtype(btnSubtype4.getText(), plastikSubtypes[3].pricePerKg, processStorageA);
}

// Fungsi yang dipanggil ketika salah satu subjenis dari Kertas dipilih
void subtypeKertas1(void *ptr) {
  processSubtype(btnSubtype1.getText(), kertasSubtypes[0].pricePerKg, processStorageB);
}

void subtypeKertas2(void *ptr) {
  processSubtype(btnSubtype2.getText(), kertasSubtypes[1].pricePerKg, processStorageB);
}

void subtypeKertas3(void *ptr) {
  processSubtype(btnSubtype3.getText(), kertasSubtypes[2].pricePerKg, processStorageB);
}

void subtypeKertas4(void *ptr) {
  processSubtype(btnSubtype4.getText(), kertasSubtypes[3].pricePerKg, processStorageB);
}

// Fungsi yang dipanggil ketika salah satu subjenis dari Besi dipilih
void subtypeBesi1(void *ptr) {
  processSubtype(btnSubtype1.getText(), besiSubtypes[0].pricePerKg, processStorageC);
}

void subtypeBesi2(void *ptr) {
  processSubtype(btnSubtype2.getText(), besiSubtypes[1].pricePerKg, processStorageC);
}

void subtypeBesi3(void *ptr) {
  processSubtype(btnSubtype3.getText(), besiSubtypes[2].pricePerKg, processStorageC);
}

void subtypeBesi4(void *ptr) {
  processSubtype(btnSubtype4.getText(), besiSubtypes[3].pricePerKg, processStorageC);
}

void subtypeBesi5(void *ptr) {
  processSubtype(btnSubtype5.getText(), besiSubtypes[4].pricePerKg, processStorageC);
}

// Fungsi yang dipanggil ketika salah satu subjenis dari Kaca dipilih
void subtypeKaca1(void *ptr) {
  processSubtype(btnSubtype1.getText(), kacaSubtypes[0].pricePerKg, processStorageD);
}

void subtypeKaca2(void *ptr) {
  processSubtype(btnSubtype2.getText(), kacaSubtypes[1].pricePerKg, processStorageD);
}

void subtypeKaca3(void *ptr) {
  processSubtype(btnSubtype3.getText(), kacaSubtypes[2].pricePerKg, processStorageD);
}

void subtypeKaca4(void *ptr) {
  processSubtype(btnSubtype4.getText(), kacaSubtypes[3].pricePerKg, processStorageD);
}

// Fungsi untuk memproses penyetoran sampah di storage A (Plastik)
void processStorageA() {
  if (detectItems(TRIG_PIN_A, ECHO_PIN_A) > 0) {
    servoA.write(180);  // Buka penutup (180 derajat)
    delay(1000);
    float currentWeight = scaleA.get_units(5);
    float newWeight = currentWeight - previousWeight;
    previousWeight = currentWeight;
    processResult(newWeight);
    servoA.write(90);  // Tutup penutup (90 derajat)
  }
}

// Fungsi untuk memproses penyetoran sampah di storage B (Kertas)
void processStorageB() {
  if (detectItems(TRIG_PIN_B, ECHO_PIN_B) > 0) {
    servoB.write(180);  // Buka penutup (180 derajat)
    delay(1000);
    float currentWeight = scaleB.get_units(5);
    float newWeight = currentWeight - previousWeight;
    previousWeight = currentWeight;
    processResult(newWeight);
    servoB.write(90);  // Tutup penutup (90 derajat)
  }
}

// Fungsi untuk memproses penyetoran sampah di storage C (Besi)
void processStorageC() {
  if (detectItems(TRIG_PIN_C, ECHO_PIN_C) > 0) {
    servoC.write(180);  // Buka penutup (180 derajat)
    delay(1000);
    float currentWeight = scaleC.get_units(5);
    float newWeight = currentWeight - previousWeight;
    previousWeight = currentWeight;
    processResult(newWeight);
    servoC.write(90);  // Tutup penutup (90 derajat)
  }
}

// Fungsi untuk memproses penyetoran sampah di storage D (Kaca)
void processStorageD() {
  if (detectItems(TRIG_PIN_D, ECHO_PIN_D) > 0) {
    servoD.write(180);  // Buka penutup (180 derajat)
    delay(1000);
    float currentWeight = scaleD.get_units(5);
    float newWeight = currentWeight - previousWeight;
    previousWeight = currentWeight;
    processResult(newWeight);
    servoD.write(90);  // Tutup penutup (90 derajat)
  }
}

// Fungsi untuk menghitung total harga dan menampilkan hasil
void processResult(float newWeight) {
  float totalPrice = newWeight * pricePerKg;

  // Tampilkan di halaman info setoran
  char itemBuffer[20], weightBuffer[10], totalBuffer[10];
  sprintf(itemBuffer, "%s", selectedSubtype.c_str());
  sprintf(weightBuffer, "%.2f kg", newWeight);
  sprintf(totalBuffer, "Rp %.2f", totalPrice);

  txtItem.setText(itemBuffer);
  txtWeight.setText(weightBuffer);
  txtTotal.setText(totalBuffer);

  // Update saldo
  currentSaldo += totalPrice;

  pageInfoSetoran.show();
}

// Fungsi untuk mendeteksi barang dengan sensor ultrasonik
int detectItems(int trigPin, int echoPin) {
  digitalWrite(trigPin, LOW);
  delayMicroseconds(2);
  digitalWrite(trigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin, LOW);

  long duration = pulseIn(echoPin, HIGH);
  int distance = duration * 0.034 / 2; // Jarak dalam cm

  if (distance < 10) {  // Jika ada barang terdeteksi
    return 1;
  }
  return 0;
}

// Fungsi untuk mengambil data saldo dari API/database
void showSaldo() {
  // Pastikan ESP32 terhubung ke WiFi
  if (WiFi.status() == WL_CONNECTED) {
    HTTPClient http;

    // URL API untuk mendapatkan data saldo berdasarkan ID RFID pengguna yang sedang login
    String url = "http://your-api.com/getSaldo?rfid=" + currentOwnerRFID;
    http.begin(url); // Memulai HTTP request dengan URL

    // Lakukan GET request
    int httpResponseCode = http.GET();

    // Jika request berhasil (kode respons HTTP 200)
    if (httpResponseCode == 200) {
      String payload = http.getString(); // Mendapatkan respons dari server
      Serial.println("Saldo diterima:");
      Serial.println(payload);

      // Parsing respons JSON untuk mendapatkan saldo
      // Misal format JSON: {"saldo": 430000}
      StaticJsonDocument<200> doc;
      DeserializationError error = deserializeJson(doc, payload);

      if (!error) {
        float saldo = doc["saldo"]; // Mengambil nilai saldo dari JSON

        // Menyusun teks saldo yang akan ditampilkan di HMI
        char saldoBuffer[20];
        sprintf(saldoBuffer, "Rp %.2f", saldo);

        // Tampilkan saldo di halaman info_saldo HMI
        txtSaldo.setText(saldoBuffer);

        Serial.print("Saldo pengguna: Rp ");
        Serial.println(saldo);
      } else {
        Serial.println("Error parsing JSON");
      }
    } else {
      Serial.print("Error on HTTP request: ");
      Serial.println(httpResponseCode);
    }

    // Menutup koneksi HTTP
    http.end();
  } else {
    Serial.println("WiFi not connected");
  }

  // Pindah ke halaman info saldo di HMI
  pageInfoSaldo.show();
}

// Fungsi untuk memproses tarik tunai dan mengupdate saldo di database
void processTarikTunai() {
  char tarikBuffer[10];
  txtInputTarik.getText(tarikBuffer, sizeof(tarikBuffer));
  float amount = atof(tarikBuffer);  // Mengambil jumlah tarik tunai dari input pengguna

  if (amount > currentSaldo) {
    Serial.println("Saldo tidak cukup untuk tarik tunai");
    // Tambahkan kode untuk menampilkan pesan error di HMI jika saldo tidak cukup
  } else {
    // Kurangi saldo dari sistem lokal
    currentSaldo -= amount;

    // Kirim permintaan untuk memperbarui saldo di database
    if (updateSaldoInDatabase(currentOwnerRFID, amount)) {
      // Kirim email notifikasi setelah saldo berhasil diperbarui
      sendEmail(currentOwner, amount);
      Serial.println("Saldo diperbarui dan email notifikasi dikirim.");
    } else {
      Serial.println("Gagal memperbarui saldo di database.");
    }
  }
}

// Fungsi untuk memperbarui saldo di database (melalui HTTP POST)
bool updateSaldoInDatabase(String rfid, float amount) {
  if (WiFi.status() == WL_CONNECTED) {
    HTTPClient http;

    String url = "http://your-api.com/updateSaldo";  // Endpoint API untuk memperbarui saldo
    http.begin(url);
    http.addHeader("Content-Type", "application/x-www-form-urlencoded");

    // Data yang akan dikirim ke server: ID RFID dan jumlah tarik tunai
    String postData = "rfid=" + rfid + "&amount=" + String(amount, 2);

    // Lakukan POST request
    int httpResponseCode = http.POST(postData);

    if (httpResponseCode == 200) {
      Serial.println("Saldo berhasil diperbarui di database.");
      http.end();
      return true;
    } else {
      Serial.print("Error updating saldo: ");
      Serial.println(httpResponseCode);
      http.end();
      return false;
    }
  } else {
    Serial.println("WiFi not connected");
    return false;
  }
}

// Fungsi untuk mengirim email notifikasi
void sendEmail(String owner, float amount) {
  WiFiClientSecure client;
  SMTPClient smtp(&client);

  smtp.setServer("smtp.gmail.com", 465);
  smtp.setLogin("your-email@gmail.com", "your-password");

  String emailContent = "Pengguna " + owner + " ingin menarik tunai sebesar Rp " + String(amount, 2);

  smtp.beginMessage();
  smtp.addRecipient("manager@example.com");
  smtp.addSubject("Permintaan Tarik Tunai");
  smtp.addBody(emailContent);
  smtp.endMessage();

  Serial.println("Email notifikasi terkirim ke manager.");
}


// Fungsi untuk mengambil data mutasi rekening dari API/database
void showMutasiRekening() {
  // Koneksi ke WiFi harus sudah tersambung
  if (WiFi.status() == WL_CONNECTED) {
    HTTPClient http;

    // Mengakses API untuk mengambil data mutasi berdasarkan ID RFID
    String url = "http://your-api.com/getMutasi?rfid=" + currentOwnerRFID;
    http.begin(url); // URL API untuk mendapatkan data

    // Lakukan GET request
    int httpResponseCode = http.GET();

    // Jika request berhasil (kode respons HTTP 200)
    if (httpResponseCode == 200) {
      String payload = http.getString(); // Mendapatkan respons dari server
      Serial.println("Mutasi rekening diterima:");
      Serial.println(payload);

      // Parsing respons JSON untuk menampilkan data
      // Misal format JSON: {"mutasi": [{"tanggal": "20-10-2024", "transaksi": "Setor", "jumlah": 200000}, {...}]}
      StaticJsonDocument<512> doc;
      DeserializationError error = deserializeJson(doc, payload);

      if (!error) {
        String mutasiText = "Mutasi Transaksi:\n";
        for (JsonObject item : doc["mutasi"].as<JsonArray>()) {
          String tanggal = item["tanggal"];
          String transaksi = item["transaksi"];
          int jumlah = item["jumlah"];

          // Menyusun teks untuk ditampilkan di HMI
          mutasiText += tanggal + ", " + transaksi + ", Rp " + String(jumlah) + "\n";
        }

        // Tampilkan mutasi di halaman mutasi_rekening HMI
        txtMutasi.setText(mutasiText.c_str());
      } else {
        Serial.println("Error parsing JSON");
      }
    } else {
      Serial.print("Error on HTTP request: ");
      Serial.println(httpResponseCode);
    }

    // Menutup koneksi HTTP
    http.end();
  } else {
    Serial.println("WiFi not connected");
  }

  // Pindah ke halaman mutasi rekening di HMI
  pageMutasiRekening.show();
}

// Fungsi untuk memproses penyetoran sampah (processStorageA)
void processStorageA() {
  // Buka penutup storage A
  servoA.write(180);  // Buka penutup (180 derajat)
  delay(1000);

  // Deteksi jumlah barang yang masuk dengan sensor ultrasonik
  int currentItemCount = detectItems(TRIG_PIN_A, ECHO_PIN_A);
  if (currentItemCount != itemCountA) {
    Serial.print("Barang masuk: ");
    Serial.println(currentItemCount);
    itemCountA = currentItemCount;
  }

  // Proses penutupan setelah setor
  servoA.write(90);  // Tutup penutup (90 derajat)

  // Baca berat barang yang masuk
  float currentWeight = scaleA.get_units(5);
  float newWeight = currentWeight - previousWeightA;
  totalWeightA += newWeight;
  previousWeightA = currentWeight;

  Serial.print("Total berat barang yang masuk: ");
  Serial.print(newWeight);
  Serial.println(" kg");
}

// Fungsi yang dipanggil ketika tombol "Info Saldo" ditekan
void infoSaldo(void *ptr) {
  showSaldo();
}

// Fungsi yang dipanggil ketika tombol "Tarik Tunai" ditekan
void tarikTunai(void *ptr) {
  pageTarikTunai.show();
}

// Fungsi yang dipanggil ketika tombol "Mutasi Rekening" ditekan
void mutasiRekening(void *ptr) {
  showMutasiRekening();
}

// Fungsi yang dipanggil ketika tombol "Kirim Tarik Tunai" ditekan
void kirimTarik(void *ptr) {
  processTarikTunai();
}

